# X5N-phy无法正常连接路由器

## 1. 缺陷描述（场景、步骤、预期、实际）

### 1.1 场景

---

X5N非智能版项目已经发布软件，发到国外前方客户装车测试，外接一个外国的百兆路由器，路有器电源由X5N主机供电，装车时主机设备和路由器同时上电，主机为单phy方案，如下图所示

![20210615192747](https://cdn.jsdelivr.net/gh/cairufan/image@main//picture/20210615192747.png)

---

### 1.2 操作步骤

- 百兆路由器通过网线和X5N主机RJ45连接

- 路由器电源接到X5N主机的12V供电

- 主机设备上电，设备启动，同时给路由器供电

### 1.3 预期结果

- 网络正常，能获取到IP并能连通外网服务器

### 1.4 实际结果

- 网络一直无法连接外网服务器，且不能PING通路由器，但是此时phy芯片显示和路由器是处于连接状态的，就是网络不通

## 2. 问题分析过程

### 2.1 初步怀疑点分析及尝试

此问题向阳同学前期在努力跟踪，做过多方面的分析及尝试，发现设备连接不上，只要过一段时间后手动ifconfig eth0 down后再ifconfig eth0 up，手动重启下设备eth0网卡，网卡就能PING通路由器；  
所以初步的尝试解决的方案是修改rootfs启动脚本，在主机设备启动的时候先延后30秒再自动重启下设备eth0网卡，然后再跑mainbusiness fcgi等进程处理；  
虽然自测通过了，但是到了客户现场，还是有概率出现无法连接外网服务器，无法PING通路由器的情况，问题又回到了原点；

### 2.2 分析phy芯片的寄存器状态

开会讨论后，大师给了一个初步的方向，由phy芯片的寄存器下手，获取对比phy芯片在能正常连接路由器和无法连接路由器时的所有寄存器状态值，找出差异点；

步骤如下

- 找到对应phy芯片的规格书和register map说明

- 根据register map的地址说明，写个demo，遍历所有的寄存器地址

- 准备测试环境，在正常和非正常时运行demo，获取所有寄存器地址的值做对比

- 最后再重新用手动输入ifconfig eth0 down up的方式再获取一遍寄存器做对比，用于排除此操作下寄存器值变化引起的差异

经过一系列的测试和验证查找，排除无关系的寄存器值，基本只剩2-3个寄存器值得怀疑，然后集中精力复现现场，确认这几个寄存器在异常情况的值是否符合预想，最后锁定一个寄存器状态，假定这个寄存器地址是在异常情况下才会有值且不为0的情况 寄存器描述如下图

![20210615201916](https://cdn.jsdelivr.net/gh/cairufan/image@main//picture/20210615201916.png)

下一步的解决方案是新增一个脚本进程，在设备启动时执行，时刻都在监测phy芯片的连接状态和这个寄存器的值，当存在符合异常情况的条件触发时，重新写入phy寄存器地址值，使其重新协商并复位phy芯片，自测通过，能恢复在异常情况时的网络状态；  

但是路还未走完，前方测试传来不好的消息，偶尔还是会出现连接不上网络的情况，我们接着往下分析；

## 3. 最终方案

虽然问题还是存在 但是还得往下分析，通过分析前方测试的打印发现在mainbusiness运行的时候，会有概率使得脚本进程使用ioctl命令去访问phy芯片时出错，而脚本进程中对出错的处理是直接退出，导致后面的监视策略无效化；  
确认问题后，手动尝试在执行ioctl命令访问phy芯片时使用ifconfig eth0 down时，确实是会报错退出脚本进程，我们最后需要做的就是再次修改脚本进程，在ioctl报错时不退出进程，重新close然后open套接字，继续监视异常情况是否触发；  
自测并通过前方测试反复验证，已经不会出现连接不上路由器的情况，测试正常，自此解决方案最终完成  

**小插曲**  
用户现场反馈还是存在少量无法连接的情况，客户装车是正常的，但是客户把环境搭在办公室内拷机（定时上电15分钟，断电15分钟），然后路由器同时接PC端，在PC上用cmd一直ping我们的设备，观察ping的情况；  
但是我们自己在测试部也搭了一样的环境，外加上弄了一个PC的ping脚本，能实时打印并保存ping的情况和本地时间戳，用ping打印上的时间戳和我们设备的打印时间戳（主要是secureCRT自带的本地时间戳）相结合对比，拷机两天都没有问题，基本每次开机2分钟内就能ping通设备；所以有理由怀疑客户的测试方式和结论，后续发了PC端的PING脚本到客户现场，由前方技术支持搭建环境按着我们的测试方式复现，后续--待续

## 4. 总结及收获

- 分析问题前要先把准备工作做充分，从硬件的设计原理图方案到软件的应用逻辑及技术文档等这些都要先搞情况，才能方便我们把问题看得更加透彻全面

- 当有条件做对比测试的时候，要多利用对比环境做各方面的验证，同时要注意保留复现环境，不要轻易破坏复现现场，以免后续无法复现，在复现上花费大量时间

- 勇于怀疑一切，包括客户的测试步骤和结论，有时候不是你自己亲手确认的东西，单纯由个人口述的东西都要持有怀疑的态度

## 5. 附录

---

B50212EDataSheet 密码docs715576  -
[docs715576.pdf](https://cdn.jsdelivr.net/gh/cairufan/image@main//other/docs715576.pdf)

phy测试demo及脚本  -
[TestMii.cpp](https://cdn.jsdelivr.net/gh/cairufan/image@main//other/TestMii.cpp)  

---
