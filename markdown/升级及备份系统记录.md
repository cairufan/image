# 升级及备份系统记录

## 前言

- 本文档用于各部门人员对升级或者备份系统问题点自排查

## 升级注意点

### 一般流程

- 若flash类型为**nor_spi**，则IE，U盘等途径升级会在运行过程中完成升级，升级完成后重启，跑正常流程，而不需要经过备份系统
  
- 若flash类型为**EMMC**，则IE，U盘等途径升级会先把烧录文件存在备份区，置**升级标志位**通知各模块需要重启进行升级，重启后进入备份系统，从备份区中获取各分区镜像进行升级，升级完成后清除**升级标志位**，再次重启进入正常流程
  
- **升级标志位**的位置在系统的状态分区，可在**UBOOT阶段**使用status get的指令获取查看，当upgrade_addr的值为0x12345678时则进入升级流程，其他值则为正常流程
![QQ截图20210219094249](https://cdn.jsdelivr.net/gh/cairufan/image@main//picture/QQ截图20210219094249.png)

- 如果需要保证升级包能正确的烧录到各个分区，而不至于升级的时候判断升级包的版本号一致导致无法烧录的问题（版本号一致不代表内容一致，因为手动烧录时不会更新状态区版本号），可手动在**uboot阶段**或者**运行阶段**手动清除状态区参数，由上图可以看到每个分区烧录文件都有自己的小版本号，如kernel_version T21011200
  
---

1. uboot阶段清除状态区  
开机重启按住ctrl+C进入到uboot  
输入（因机型平台及flash而定）mw.l 0x1000000 0xffffffff 0x100000;mmc write 0x1000000 0x1E5800 0x8000;  
2. 运行阶段清除状态区  
开机进入正常流程  
输入（因机型分区及flash而定）dd if=/dev/zero of=/dev/mmcblk0p8 bs=1M count=1 

---
  
### 升级失败分析

- 若IE升级时显示productType boardType不匹配时，请检查升级包软件与型号是否匹配，如下图所示现象和打印
![QQ截图20210219093501](https://cdn.jsdelivr.net/gh/cairufan/image@main//picture/QQ截图20210219093501.png)
![QQ截图20210219093737](https://cdn.jsdelivr.net/gh/cairufan/image@main//picture/QQ截图20210219093737.png)

- 若升级后某一个分区异常，则需要先排查MCU是否有重启的动作，从而打断升级流程，异常分区未完成擦除写入动作导致，主要是查看打印来定位问题
  